generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model attivita {
  id             String        @id @default(uuid()) @db.Uuid
  tipoAttivita   tipo_attivita
  descrizione    String
  idEntita       String?       @db.Uuid
  tipoEntita     tipo_entita?
  userId         String        @db.Uuid
  aziendaId      String        @db.Uuid
  datiAggiuntivi Json?
  createdAt      DateTime      @default(now()) @db.Timestamptz(6)
  aziende        aziende       @relation(fields: [aziendaId], references: [id])
  users          users         @relation(fields: [userId], references: [id])

  @@index([aziendaId])
  @@index([createdAt])
  @@index([tipoAttivita])
  @@index([userId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model aziende {
  id             String          @id @default(uuid()) @db.Uuid
  nome           String
  partitaIva     String          @unique
  codiceFiscale  String?
  indirizzo      String?
  citta          String?
  cap            String?
  telefono       String?
  email          String?
  createdAt      DateTime        @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime        @updatedAt @db.Timestamptz(6)
  attivita       attivita[]
  dipendenti     dipendenti[]
  sedi           sedi[]
  users          users[]
  collaboratori  collaboratori[]
  prestazioni    prestazioni[]
  pagamenti_dipendenti pagamenti_dipendenti[]
  orari_lavoro   orari_lavoro[]
  fasce_orarie   fasce_orarie[]
  festivita      festivita[]
}

model buste_paga {
  id                String     @id @default(uuid()) @db.Uuid
  mese              Int
  anno              Int
  retribuzioneLorda Decimal    @db.Decimal(10, 2)
  straordinari      Decimal    @default(0) @db.Decimal(10, 2)
  altreCompetenze   Decimal    @default(0) @db.Decimal(10, 2)
  totaleLordo       Decimal    @db.Decimal(10, 2)
  contributiINPS    Decimal    @db.Decimal(10, 2)
  irpef             Decimal    @db.Decimal(10, 2)
  altreRitenute     Decimal    @default(0) @db.Decimal(10, 2)
  totaleRitenute    Decimal    @db.Decimal(10, 2)
  netto             Decimal    @db.Decimal(10, 2)
  tfr               Decimal    @db.Decimal(10, 2)
  oreLavorate       Decimal    @db.Decimal(6, 2)
  oreStraordinario  Decimal    @default(0) @db.Decimal(6, 2)
  storagePath       String?
  dipendenteId      String     @db.Uuid
  // Nuovi campi per gestione pagamenti interna
  acconto1          Decimal?   @default(0) @db.Decimal(10, 2)
  acconto2          Decimal?   @default(0) @db.Decimal(10, 2)
  acconto3          Decimal?   @default(0) @db.Decimal(10, 2)
  acconto4          Decimal?   @default(0) @db.Decimal(10, 2)
  totaleAcconti     Decimal?   @default(0) @db.Decimal(10, 2)
  bonus             Decimal?   @default(0) @db.Decimal(10, 2)
  importoBonifico   Decimal?   @db.Decimal(10, 2)
  differenza        Decimal?   @db.Decimal(10, 2)
  note              String?
  createdAt         DateTime   @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime   @updatedAt @db.Timestamptz(6)
  dipendenti        dipendenti @relation(fields: [dipendenteId], references: [id], onDelete: Cascade)
  pagamenti         pagamenti_dipendenti[]

  @@unique([dipendenteId, mese, anno])
  @@index([anno, mese])
  @@index([dipendenteId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model dipendenti {
  id             String           @id @default(uuid()) @db.Uuid
  nome           String
  cognome        String
  codiceFiscale  String?          @unique
  dataNascita    DateTime?        @db.Date
  luogoNascita   String?
  indirizzo      String?
  citta          String?
  cap            String?
  telefono       String?
  email          String?
  iban                String?
  dataAssunzione      DateTime         @db.Date
  dataScadenzaContratto DateTime?      @db.Date
  tipoContratto       tipo_contratto?
  ccnl                ccnl?
  note           String?
  qualifica      String?
  retribuzione   Decimal?         @db.Decimal(10, 2)
  retribuzioneNetta Decimal?      @db.Decimal(10, 2)
  // Nuovi campi per gestione limiti pagamento
  limiteBonus       Decimal?       @db.Decimal(10, 2)
  limiteBonifico    Decimal?       @db.Decimal(10, 2)
  coefficienteMaggiorazione Decimal? @default(0) @db.Decimal(5, 2) // Percentuale (es. 4.00 per 4%)
  oreSettimanali Int              @default(40)
  aziendaId      String           @db.Uuid
  sedeId         String?          @db.Uuid
  attivo         Boolean          @default(true)
  dataCessazione DateTime?        @db.Date
  createdAt      DateTime         @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime         @updatedAt @db.Timestamptz(6)
  buste_paga     buste_paga[]
  aziende        aziende          @relation(fields: [aziendaId], references: [id], onDelete: Cascade)
  sedi           sedi?            @relation(fields: [sedeId], references: [id])
  documenti      documenti[]
  ferie_permessi ferie_permessi[]
  presenze       presenze[]
  turni          turni[]
  pagamenti      pagamenti_dipendenti[]

  @@index([aziendaId])
  @@index([codiceFiscale])
}

model documenti {
  id           String         @id @default(uuid()) @db.Uuid
  tipo         tipo_documento
  numero       String?
  dataRilascio DateTime?      @db.Date
  dataScadenza DateTime?      @db.Date
  storagePath  String
  fileName     String
  fileSize     Int?
  mimeType     String?
  dipendenteId String         @db.Uuid
  createdAt    DateTime       @default(now()) @db.Timestamptz(6)
  dipendenti   dipendenti     @relation(fields: [dipendenteId], references: [id], onDelete: Cascade)

  @@index([dataScadenza])
  @@index([dipendenteId])
}

model ferie_permessi {
  id           String          @id @default(uuid()) @db.Uuid
  tipo         tipo_assenza
  dataInizio   DateTime        @db.Date
  dataFine     DateTime        @db.Date
  giorni       Int
  stato        stato_richiesta @default(IN_ATTESA)
  motivazione  String?
  dipendenteId String          @db.Uuid
  createdAt    DateTime        @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime        @updatedAt @db.Timestamptz(6)
  dipendenti   dipendenti      @relation(fields: [dipendenteId], references: [id], onDelete: Cascade)

  @@index([dipendenteId])
  @@index([stato])
}

/// Pagamenti effettuati ai dipendenti (acconti e saldi)
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model pagamenti_dipendenti {
  id             String         @id @default(uuid()) @db.Uuid
  importo        Decimal        @db.Decimal(10, 2)
  tipoPagamento  tipo_pagamento
  dataPagamento  DateTime       @db.Date
  mese           Int            @default(11) // Mese di riferimento (1-12)
  anno           Int            @default(2025) // Anno di riferimento (es. 2025)
  note           String?
  dipendenteId   String         @db.Uuid
  bustaPagaId    String?        @db.Uuid
  aziendaId      String         @db.Uuid
  createdAt      DateTime       @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime       @updatedAt @db.Timestamptz(6)
  dipendenti     dipendenti     @relation(fields: [dipendenteId], references: [id], onDelete: Cascade)
  buste_paga     buste_paga?    @relation(fields: [bustaPagaId], references: [id], onDelete: SetNull)
  aziende        aziende        @relation(fields: [aziendaId], references: [id], onDelete: Cascade)

  @@index([dipendenteId])
  @@index([aziendaId])
  @@index([dataPagamento])
  @@index([bustaPagaId])
  @@index([mese, anno])
}

model presenze {
  id               String          @id @default(uuid()) @db.Uuid
  data             DateTime        @db.Date
  entrata          DateTime?       @db.Timestamptz(6)
  uscita           DateTime?       @db.Timestamptz(6)
  oreLavorate      Decimal?        @db.Decimal(5, 2)
  oreStraordinario Decimal?        @db.Decimal(5, 2)
  nota             String?
  dipendenteId     String          @db.Uuid
  turnoId          String?         @db.Uuid
  stato            stato_presenza  @default(DA_CONFERMARE)
  generataDaTurno  Boolean         @default(false)
  createdAt        DateTime        @default(now()) @db.Timestamptz(6)
  updatedAt        DateTime        @updatedAt @db.Timestamptz(6)
  dipendenti       dipendenti      @relation(fields: [dipendenteId], references: [id], onDelete: Cascade)
  turni            turni?          @relation(fields: [turnoId], references: [id], onDelete: SetNull)

  @@index([data])
  @@index([dipendenteId])
  @@index([turnoId])
  @@index([stato])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model sedi {
  id         String       @id @default(uuid()) @db.Uuid
  nome       String
  indirizzo  String?
  citta      String?
  aziendaId  String       @db.Uuid
  createdAt  DateTime     @default(now()) @db.Timestamptz(6)
  updatedAt  DateTime     @updatedAt @db.Timestamptz(6)
  dipendenti dipendenti[]
  aziende    aziende      @relation(fields: [aziendaId], references: [id], onDelete: Cascade)
  turni      turni[]
}

model turni {
  id                String     @id @default(uuid()) @db.Uuid
  data              DateTime   @db.Date
  oraInizio         String
  oraFine           String
  pausaPranzoInizio String?    // formato HH:mm - pausa pranzo opzionale per turni spezzati
  pausaPranzoFine   String?    // formato HH:mm - pausa pranzo opzionale per turni spezzati
  tipoTurno         tipo_turno
  dipendenteId      String     @db.Uuid
  sedeId            String?    @db.Uuid
  createdAt         DateTime   @default(now()) @db.Timestamptz(6)
  dipendenti        dipendenti @relation(fields: [dipendenteId], references: [id], onDelete: Cascade)
  sedi              sedi?      @relation(fields: [sedeId], references: [id])
  presenze          presenze[]

  @@index([data])
  @@index([dipendenteId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model users {
  id        String     @id @default(uuid()) @db.Uuid
  email     String     @unique
  name      String?
  role      user_role  @default(USER)
  aziendaId String?    @db.Uuid
  createdAt DateTime   @default(now()) @db.Timestamptz(6)
  updatedAt DateTime   @updatedAt @db.Timestamptz(6)
  attivita  attivita[]
  aziende   aziende?   @relation(fields: [aziendaId], references: [id])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model collaboratori {
  id            String                @id @default(uuid()) @db.Uuid
  nome          String
  cognome       String
  codiceFiscale String
  partitaIva    String?
  email         String?
  telefono      String?
  indirizzo     String?
  tipo          tipo_collaboratore
  tariffaOraria Decimal?              @db.Decimal(10, 2)
  note          String?
  aziendaId     String                @db.Uuid
  attivo        Boolean               @default(true)
  createdAt     DateTime              @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime              @updatedAt @db.Timestamptz(6)
  aziende       aziende               @relation(fields: [aziendaId], references: [id], onDelete: Cascade)
  prestazioni   prestazioni[]

  @@unique([codiceFiscale, aziendaId])
  @@index([aziendaId])
  @@index([attivo])
  @@index([tipo])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model prestazioni {
  id              String            @id @default(uuid()) @db.Uuid
  tipo            tipo_prestazione
  descrizione     String
  dataInizio      DateTime          @db.Date
  dataFine        DateTime?         @db.Date
  oreLavorate     Decimal?          @db.Decimal(5, 2)
  tariffaOraria   Decimal?          @db.Decimal(10, 2)
  nomeProgetto    String?
  compensoFisso   Decimal?          @db.Decimal(10, 2)
  importoTotale   Decimal           @db.Decimal(10, 2)
  statoPagamento  stato_pagamento   @default(DA_PAGARE)
  dataPagamento   DateTime?         @db.Date
  note            String?
  collaboratoreId String            @db.Uuid
  aziendaId       String            @db.Uuid
  createdAt       DateTime          @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime          @updatedAt @db.Timestamptz(6)
  collaboratori   collaboratori     @relation(fields: [collaboratoreId], references: [id], onDelete: Cascade)
  aziende         aziende           @relation(fields: [aziendaId], references: [id], onDelete: Cascade)

  @@index([collaboratoreId])
  @@index([aziendaId])
  @@index([statoPagamento])
  @@index([dataInizio])
  @@index([tipo])
}

enum ccnl {
  TURISMO
  COMMERCIO
  METALMECCANICI
  ALTRO
}

enum stato_presenza {
  DA_CONFERMARE
  CONFERMATA
  ASSENTE
  MODIFICATA
}

enum stato_richiesta {
  IN_ATTESA
  APPROVATA
  RIFIUTATA
}

enum tipo_assenza {
  FERIE
  PERMESSO
  MALATTIA
  CONGEDO
}

enum tipo_attivita {
  CREAZIONE_DIPENDENTE
  MODIFICA_DIPENDENTE
  ELIMINAZIONE_DIPENDENTE
  REGISTRAZIONE_PRESENZA
  MODIFICA_PRESENZA
  ELIMINAZIONE_PRESENZA
  CREAZIONE_TURNO
  MODIFICA_TURNO
  ELIMINAZIONE_TURNO
  GENERAZIONE_BUSTA_PAGA
  MODIFICA_BUSTA_PAGA
  ELIMINAZIONE_BUSTA_PAGA
  RICHIESTA_FERIE
  APPROVAZIONE_FERIE
  RIFIUTO_FERIE
}

enum tipo_contratto {
  TEMPO_INDETERMINATO
  TEMPO_DETERMINATO
  APPRENDISTATO
  STAGIONALE
  PARTTIME
}

enum tipo_documento {
  CARTA_IDENTITA
  PERMESSO_SOGGIORNO
  CODICE_FISCALE
  CONTRATTO
  VISITA_MEDICA
  ALTRO
}

enum tipo_entita {
  DIPENDENTE
  PRESENZA
  TURNO
  BUSTA_PAGA
  FERIE_PERMESSI
}

enum tipo_turno {
  MATTINA
  PRANZO
  SERA
  NOTTE
  SPEZZATO
}

enum user_role {
  SUPER_ADMIN
  ADMIN
  MANAGER
  USER
}

enum tipo_collaboratore {
  PRESTAZIONE_OCCASIONALE
  PARTITA_IVA
  CONSULENTE
}

enum tipo_prestazione {
  ORARIA
  PROGETTO
}

enum stato_pagamento {
  DA_PAGARE
  PAGATO
  ANNULLATO
}

enum tipo_pagamento {
  BONUS
  BONIFICO
}

/// Orari di lavoro standard configurabili per l'azienda
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model orari_lavoro {
  id                String   @id @default(uuid()) @db.Uuid
  nome              String   // es. "Orario Full-time", "Part-time mattina"
  oraInizio         String   // formato HH:mm es. "08:00"
  oraFine           String   // formato HH:mm es. "17:00"
  pausaPranzoInizio String?  // formato HH:mm es. "12:00"
  pausaPranzoFine   String?  // formato HH:mm es. "13:00"
  oreTotali         Decimal  @db.Decimal(4, 2) // ore totali giornaliere
  aziendaId         String   @db.Uuid
  attivo            Boolean  @default(true)
  createdAt         DateTime @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime @updatedAt @db.Timestamptz(6)
  aziende           aziende  @relation(fields: [aziendaId], references: [id], onDelete: Cascade)

  @@index([aziendaId])
  @@index([attivo])
}

/// Fasce orarie predefinite per turni
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model fasce_orarie {
  id                String     @id @default(uuid()) @db.Uuid
  nome              String     // es. "Mattina", "Pomeriggio", "Sera"
  tipoTurno         tipo_turno
  oraInizio         String     // formato HH:mm
  oraFine           String     // formato HH:mm
  pausaPranzoInizio String?    // formato HH:mm - solo per turni SPEZZATO
  pausaPranzoFine   String?    // formato HH:mm - solo per turni SPEZZATO
  maggiorazione     Decimal    @default(0) @db.Decimal(5, 2) // percentuale maggiorazione (es. 20 per +20%)
  aziendaId         String     @db.Uuid
  attivo            Boolean    @default(true)
  createdAt         DateTime   @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime   @updatedAt @db.Timestamptz(6)
  aziende           aziende    @relation(fields: [aziendaId], references: [id], onDelete: Cascade)

  @@index([aziendaId])
  @@index([tipoTurno])
  @@index([attivo])
}

/// Festivit√† e chiusure aziendali
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model festivita {
  id            String   @id @default(uuid()) @db.Uuid
  nome          String   // es. "Natale", "Ferragosto", "Chiusura estiva"
  data          DateTime @db.Date
  ricorrente    Boolean  @default(false) // se true, si ripete ogni anno
  maggiorazione Decimal  @default(0) @db.Decimal(5, 2) // percentuale maggiorazione
  aziendaId     String   @db.Uuid
  createdAt     DateTime @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @db.Timestamptz(6)
  aziende       aziende  @relation(fields: [aziendaId], references: [id], onDelete: Cascade)

  @@index([aziendaId])
  @@index([data])
}
